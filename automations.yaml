- id: '1721300000000'
  alias: 'Append Scanned Key to Input Text'
  description: 'Converts numeric key_code to character and appends it to the input_text buffer.'
  mode: queued
  trigger:
    - platform: event
      event_type: keyboard_remote_command_received
  condition:
    - condition: template
      value_template: "{{ trigger.event.data.type == 'key_down' }}"
  action:
    - service: input_text.set_value
      target:
        entity_id: input_text.last_qr_code_scanned
      data:
        value: >
          {%- set key_map = {
            2: "1", 3: "2", 4: "3", 5: "4", 6: "5",
            7: "6", 8: "7", 9: "8", 10: "9", 11: "0",
            12: "-", 13: "=",
            16: "q", 17: "w", 18: "e", 19: "r", 20: "t",
            21: "y", 22: "u", 23: "i", 24: "o", 25: "p",
            30: "a", 31: "s", 32: "d", 33: "f", 34: "g",
            35: "h", 36: "j", 37: "k", 38: "l",
            44: "z", 45: "x", 46: "c", 47: "v", 48: "b",
            49: "n", 50: "m"
          } -%}
          {%- set current_char = key_map.get(trigger.event.data.key_code, '') -%}
          {{ states('input_text.last_qr_code_scanned') + current_char }}

- id: '1721300000001'
  alias: 'Trigger QR Verification on Enter Key'
  description: 'When the Enter key is detected, call the API and then clear the buffer.'
  mode: single
  trigger:
    - platform: event
      event_type: keyboard_remote_command_received
      event_data:
        key_code: 28
        type: key_down
  condition:
    - condition: template
      value_template: "{{ states('input_text.last_qr_code_scanned') | length > 0 }}"
  action:
    - service: rest_command.verify_qr_code
      data:
        qr_secret_data: "{{ states('input_text.last_qr_code_scanned') }}"
    - service: persistent_notification.create
      data:
        title: "QR Code Scanned and Verified"
        message: "Sent value: {{ states('input_text.last_qr_code_scanned') }}"
    - delay:
        milliseconds: 500
    - service: input_text.set_value
      target:
        entity_id: input_text.last_qr_code_scanned
      data:
        value: ""

- id: '1721400000000'
  alias: '[NEW] Trigger Door Open on Calendar Event'
  description: 'Listens for a specific event on the Google Calendar to trigger the door opening mechanism.'
  trigger:
    - platform: calendar
      # IMPORTANT: Replace 'calendar.your_door_control_calendar' with the actual entity ID of your door control calendar in HA.
      entity_id: calendar.your_door_control_calendar
      event: start
  condition:
    # Only trigger if the event summary is exactly 'OPEN_DOOR'
    - condition: template
      value_template: "{{ trigger.calendar_event.summary == 'OPEN_DOOR' }}"
  action:
    - service: switch.turn_on
      target:
        # IMPORTANT: Replace this with the actual entity ID of your door lock switch.
        entity_id: switch.sonoff_1000abcdef
    - delay:
        seconds: 5
    - service: switch.turn_off
      target:
        entity_id: switch.sonoff_1000abcdef
    - service: persistent_notification.create
      data:
        title: "âœ… Door Opened via Calendar"
        message: "Door opened due to trigger event: {{ trigger.calendar_event.summary }}."
    # Action to delete the trigger event from the calendar after it has been used.
    # This prevents the door from opening again on the next HA restart.
    - service: google.delete_event
      data:
        calendar_id: calendar.your_door_control_calendar
        entity_id: "{{ trigger.calendar_event.entity_id }}"
  mode: single
